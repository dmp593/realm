document.addEventListener("DOMContentLoaded",(function(){var e=new DataTransfer,t=document.getElementById("progress-bar"),n=document.querySelector('button[type="submit"]');document.getElementById("files").addEventListener("change",(function(t){var n=document.getElementById("preview-container");Array.from(t.target.files).forEach((function(r,a){e.items.add(r);var o=document.createElement("div");if(o.classList.add("relative","w-full","h-32","rounded-lg","shadow-md","overflow-hidden"),r.type.startsWith("image/")){var d=new FileReader;d.onload=function(e){var t=document.createElement("img");t.src=e.target.result,t.classList.add("w-full","h-full","object-cover"),o.appendChild(t)},d.readAsDataURL(r)}else if(r.type.startsWith("video/"))if(r.size<262144e3){var i=new FileReader;i.onload=function(e){var t=document.createElement("video");t.src=e.target.result,t.classList.add("w-full","h-full","object-cover"),t.controls=!0,o.appendChild(t)},i.readAsDataURL(r)}else{var s=document.createElement("i");s.classList.add("ph-bold","ph-video","text-4xl","text-gray-500","flex","items-center","justify-center","w-full","h-full"),o.appendChild(s)}else{var l=document.createElement("i");l.classList.add("ph-bold","ph-file","text-4xl","text-gray-500","flex","items-center","justify-center","w-full","h-full"),o.appendChild(l)}var c=document.createElement("span");c.innerHTML='<i class="ph-bold ph-x"></i>',c.classList.add("absolute","top-1","right-1","bg-red-500","text-white","rounded-full","w-6","h-6","flex","items-center","justify-center","cursor-pointer","z-50"),c.addEventListener("click",(function(){o.remove(),e.items.remove(a),t.target.files=e.files})),o.appendChild(c),n.appendChild(o)})),t.target.files=e.files})),document.getElementById("house-form").addEventListener("submit",(function(r){r.preventDefault(),n.classList.add("disabled"),n.disabled=!0,n.innerHTML="A processar...";var a=new FormData(this);fetch("{% url 'house_create' %}",{method:"POST",body:a,headers:{"X-CSRFToken":"{{ csrf_token }}"}}).then((function(e){return e.json()})).then((function(n){n.house_id?function(n){return new Promise((function(r,a){var o=e.files,d=1048576,i=3,s=0,l=[],c=0,u=Array.from(o).reduce((function(e,t){return e+t.size}),0);function f(e,n,r,a,o,i,l){var f=e.slice(n*d,(n+1)*d),m=new FormData;m.append("file",f),m.append("chunkIndex",n),m.append("totalChunks",r),m.append("fileId",a),m.append("houseId",o),m.append("filename",i),m.append("order",l),fetch("{% url 'upload_chunk' %}",{method:"POST",body:m,headers:{"X-CSRFToken":"{{ csrf_token }}"}}).then((function(e){return e.json()})).then((function(e){"ok"===e.status&&(c+=f.size,t.style.width="".concat(c/u*100,"%")),s--,h()})).catch((function(e){s--,h()}))}function h(){for(;s<i&&l.length>0;){var e=l.shift(),t=e.file,n=e.chunkIndex,a=e.totalChunks,o=e.fileId,d=e.houseId,c=e.filename,u=e.order;s++,f(t,n,a,o,d,c,u)}0===l.length&&0===s&&r()}Array.from(o).forEach((function(e,t){for(var r=Math.ceil(e.size/d),a="house_".concat(t),o=0;o<r;o++)l.push({file:e,chunkIndex:o,totalChunks:r,fileId:a,houseId:n,filename:e.name,order:t+1})})),h()}))}(n.house_id).then((function(){window.location.href=n.success_url})):n.errors&&Object.keys(n.errors).forEach((function(e){document.getElementById("error_".concat(e)).innerHTML=n.errors[e].join("<br>")}))})).catch((function(e){})).finally((function(){n.classList.remove("disabled"),n.disabled=!1,n.innerHTML="Criar Casa"}))}))}));